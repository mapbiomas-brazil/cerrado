// -- -- -- -- 13_toWorkspace
// Script modelo para padronização dos assets do Mapbiomas~
// barbara.silva@ipam.org.br

// geometria para corrigir campo para afloramento 
var geometry_mask = ee.Image(1).clip(ee.FeatureCollection(ee.Geometry.MultiPolygon(
        [[[[-43.54367578400043, -18.53690253927378],
           [-43.54607904327777, -18.509557440463933],
           [-43.552945498355896, -18.496860015981152],
           [-43.58762109650043, -18.489696950925],
           [-43.614400271305115, -18.515743024006678],
           [-43.61646020782855, -18.52583481176097],
           [-43.62298334015277, -18.529090100124872],
           [-43.632596377262146, -18.544063628062915],
           [-43.65044916046527, -18.54927150407182],
           [-43.654569033512146, -18.538204577743524],
           [-43.66692865265277, -18.537553559748883],
           [-43.676541689762146, -18.55480469829488],
           [-43.684094790348084, -18.54504011691155],
           [-43.69885766876605, -18.551875382515696],
           [-43.70641076935199, -18.558710374469605],
           [-43.711560610660584, -18.567823271247534],
           [-43.714307192691834, -18.573030422263557],
           [-43.71533716095355, -18.577261115383273],
           [-43.720487002262146, -18.58409509016656],
           [-43.72117364776996, -18.59450823901314],
           [-43.720487002262146, -18.60492075119571],
           [-43.71739709747699, -18.616959424352938],
           [-43.72735345734027, -18.62541852281276],
           [-43.72460687530902, -18.638431698519668],
           [-43.717740420230896, -18.666081386480315],
           [-43.613370303043396, -18.68624655189411],
           [-43.55088556183246, -18.682669036326683],
           [-43.53234613312152, -18.617935495650585],
           [-43.53571571149347, -18.5616395729437]]],
         [[[-43.68437446393487, -18.77937018612342],
           [-43.674074781317685, -18.759216126441153],
           [-43.68952430524347, -18.703617456592323],
           [-43.71836341657159, -18.660036136969975],
           [-43.735186231513, -18.65645806831971],
           [-43.765741956610654, -18.65353050148915],
           [-43.7846247080755, -18.660686686799753],
           [-43.78050483502862, -18.686381408998123],
           [-43.770205152411435, -18.704593029452703],
           [-43.77089179791925, -18.713698104915327],
           [-43.75681556500909, -18.75401468779212],
           [-43.72660316266534, -18.773519255707004],
           [-43.713213575263, -18.77611969430262]]]])));
           
// mask to remove wetland from geomorfology
var wetland_to_grassland = ee.Image(1).clip(ee.FeatureCollection(ee.Geometry.MultiPolygon(
        [[[[-58.35715967096754, -13.65902188999379],
           [-58.35715967096754, -13.82976962831706],
           [-58.009717044014415, -13.82976962831706],
           [-58.009717044014415, -13.65902188999379]]],
         [[[-55.85895058657032, -14.292089975688981],
           [-55.85895058657032, -14.449067886431282],
           [-55.68591591860157, -14.449067886431282],
           [-55.68591591860157, -14.292089975688981]]],
         [[[-55.27392861391407, -14.2668035942895],
           [-55.27392861391407, -14.6338404028623],
           [-54.89352700258595, -14.6338404028623],
           [-54.89352700258595, -14.2668035942895]]],
         [[[-46.62723511748545, -16.77353976875004],
           [-46.62723511748545, -16.7929329851731],
           [-46.59667939238779, -16.7929329851731],
           [-46.59667939238779, -16.77353976875004]]],
         [[[-45.67217425963185, -16.310485298715367],
           [-45.67217425963185, -16.391526813509252],
           [-45.62479571959279, -16.391526813509252],
           [-45.62479571959279, -16.310485298715367]]],
         [[[-45.30390586423229, -16.347017198894918],
           [-45.30390586423229, -16.596575270824136],
           [-45.16657676266979, -16.596575270824136],
           [-45.16657676266979, -16.347017198894918]]],
         [[[-45.297039409154166, -16.49916078102644],
           [-45.297039409154166, -16.586046348715648],
           [-45.224941630833854, -16.586046348715648],
           [-45.224941630833854, -16.49916078102644]]],
         [[[-45.32313193845104, -16.50442768627535],
           [-45.32313193845104, -16.644606155773417],
           [-45.299785991185416, -16.644606155773417],
           [-45.299785991185416, -16.50442768627535]]],
         [[[-45.38561667966198, -16.556430666497214],
           [-45.38561667966198, -16.631448204804006],
           [-45.29566611813854, -16.631448204804006],
           [-45.29566611813854, -16.556430666497214]]],
         [[[-45.357464213841666, -16.530760059937975],
           [-45.357464213841666, -16.56037968726312],
           [-45.31969871091198, -16.56037968726312],
           [-45.31969871091198, -16.530760059937975]]]])));
           
var wetland_to_grassland2 = ee.Image(1).clip(ee.FeatureCollection(ee.Geometry.MultiPolygon(
        [[[-45.2483832882216, -16.362766029840177],
          [-45.28820872767473, -16.468151020580134],
          [-45.38845897181535, -16.566897444058696],
          [-45.37335277064348, -16.644542416918384],
          [-45.35412669642473, -16.627436898920447],
          [-45.31018138392473, -16.63927934314271],
          [-45.27310252650285, -16.590589066301014],
          [-45.18109202845598, -16.560315920465005],
          [-45.1934516475966, -16.51687223008368],
          [-45.20031810267473, -16.46156613307534],
          [-45.15637279017473, -16.44312725862372],
          [-45.1714789913466, -16.366718996670713]]])));

var bap_encosta = ee.Image(1).clip(ee.FeatureCollection(ee.Geometry.Polygon(
        [[[-57.57503224426449, -15.648492656901542],
          [-57.7343347731885, -16.102885822487387],
          [-57.94307598640752, -16.561506416725173],
          [-57.86067837585932, -16.798298419671553],
          [-57.62447145570533, -16.740443166710225],
          [-57.311359876089256, -16.466708149556993],
          [-57.2289619662136, -16.092330454287925],
          [-56.87739839362672, -16.414022381604752],
          [-56.69611656193542, -16.454921473048778],
          [-56.53956764276189, -16.445635591348623],
          [-56.34318589048461, -16.461439702955033],
          [-56.15504412086058, -16.450902616950614],
          [-55.872145902388816, -16.429829890910447],
          [-55.53706173785138, -16.450904294326545],
          [-55.47114355215201, -16.687832686851646],
          [-55.11408663306874, -16.703617526310477],
          [-54.98774337954124, -17.291975037544184],
          [-55.29536168903185, -17.244764846247236],
          [-55.31184124525167, -17.590690640490962],
          [-55.103100232303554, -17.674452343713142],
          [-54.982250142809754, -18.134440303552427],
          [-55.15253885985316, -19.06131836719384],
          [-55.43818457447741, -19.709035318853797],
          [-55.828200929725945, -20.23563999348803],
          [-55.871461832579705, -20.301678853963082],
          [-55.837129428769465, -20.453586492464957],
          [-55.80142370840843, -20.47031292354901],
          [-55.71833922403393, -20.33516288668755],
          [-55.594742487351326, -20.226957691451],
          [-55.5260776352605, -20.149622114350873],
          [-55.50959806741282, -20.067088594929523],
          [-55.50015649007394, -20.00209524541355],
          [-55.40797409428637, -19.98322101894601],
          [-55.379821507655215, -19.953534092954634],
          [-55.35817648221946, -19.87374541610876],
          [-55.310797740406045, -19.785252408747105],
          [-55.337577027180586, -19.73355489754233],
          [-55.329029580516725, -19.715588310801234],
          [-55.317356557606246, -19.696841721504097],
          [-55.266563675850065, -19.73431629125299],
          [-55.26330209598451, -19.744495514546774],
          [-55.25042743854981, -19.746272772694052],
          [-55.24253098205042, -19.730438321217],
          [-55.23944106431936, -19.721227765177268],
          [-55.259353867705656, -19.711208663029094],
          [-55.264847054813124, -19.694724258256077],
          [-55.270235935628406, -19.687668704562224],
          [-55.27710241946048, -19.677647501036386],
          [-55.27624410895128, -19.670696943379465],
          [-55.2820806201799, -19.66293782529565],
          [-55.284655551593126, -19.658734812890376],
          [-55.28431222732729, -19.64580177632193],
          [-55.289633752223345, -19.638041454061344],
          [-55.29032040056705, -19.633029379940965],
          [-55.285342199731666, -19.617992219318555],
          [-55.28176810834659, -19.605098370110618],
          [-55.27455830041427, -19.604289815956832],
          [-55.26305694015206, -19.609141080105697],
          [-55.25430217338688, -19.59668920804998],
          [-55.26031034664862, -19.591352396488677],
          [-55.25962369827621, -19.585691948468845],
          [-55.262713615941585, -19.57938435772649],
          [-55.257563753166345, -19.576958295520637],
          [-55.25876538781482, -19.566930184213618],
          [-55.25695338812453, -19.558665639670245],
          [-55.254378456757145, -19.55130552582607],
          [-55.24957191820198, -19.54912169118276],
          [-55.24313458982639, -19.535775392966944],
          [-55.24184712417298, -19.528899596667493],
          [-55.23136939206054, -19.513498231303927],
          [-55.22621952943589, -19.503870707587936],
          [-55.23145522303121, -19.5250666820973],
          [-55.19986939805297, -19.55030406279947],
          [-55.184419809956196, -19.542862680876553],
          [-55.171030166870395, -19.541892040353257],
          [-55.15661055150478, -19.529920329910325],
          [-55.15626722819154, -19.493352588870877],
          [-55.154550607807636, -19.472314303086524],
          [-55.13086123980302, -19.466164133717594],
          [-55.13718666909825, -19.450709193681693],
          [-55.14233653202691, -19.439378245274742],
          [-55.13804498019053, -19.427237065546368],
          [-55.15160628527896, -19.417037773706],
          [-55.16224933464766, -19.41574257991817],
          [-55.19280518602593, -19.41201884016881],
          [-55.18085182829138, -19.39364937365104],
          [-55.16437226804124, -19.39688777888586],
          [-55.13656301059264, -19.3836099061689],
          [-55.11802350580191, -19.372274280185625],
          [-55.116118944399176, -19.353584781617574],
          [-55.09895273637148, -19.344514673495734],
          [-55.08830968764211, -19.333500293401144],
          [-55.0958628197367, -19.321513212778704],
          [-55.106849193552165, -19.305961095247632],
          [-55.10719251849688, -19.28360233510585],
          [-55.117148919938, -19.260592308254772],
          [-55.12298543093036, -19.25184116870738],
          [-55.115088975482955, -19.245358541787542],
          [-55.09860941541061, -19.257675312989345],
          [-55.093459553249936, -19.251517042542737],
          [-55.08521977335164, -19.253461784161644],
          [-55.082816504958465, -19.23563412057803],
          [-55.07354675327457, -19.22201896454271],
          [-55.0793832649585, -19.197379149213308],
          [-55.07251678238798, -19.185057857228315],
          [-55.06839689308007, -19.172735643373723],
          [-55.06187373467257, -19.16170972345273],
          [-55.05088736254878, -19.146142463613398],
          [-55.04882741841029, -19.13024937149772],
          [-55.0378410464945, -19.113057162107022],
          [-55.02994459207285, -19.094240997643702],
          [-55.02857129660037, -19.073151375109518],
          [-55.04436420783632, -19.061794313286693],
          [-55.04127429167224, -19.03907785480962],
          [-55.05535058278654, -19.011814002618124],
          [-55.056380556051785, -18.993635616773048],
          [-55.05741052881347, -18.986168918796132],
          [-55.046080832486716, -18.98129915227573],
          [-55.04505086094825, -18.963442125651067],
          [-55.04333424100349, -18.94850568916963],
          [-55.0179282554175, -18.940712233869135],
          [-55.009001829215386, -18.91797924815912],
          [-54.99698548522418, -18.906936396140807],
          [-54.99080565240142, -18.881600041592378],
          [-54.986342440310864, -18.855934955749674],
          [-54.95818986194204, -18.853985546592252],
          [-54.94720348901431, -18.86568165113347],
          [-54.9248874218309, -18.85008666147608],
          [-54.91355772733869, -18.828316233319875],
          [-54.923514127513414, -18.82149208646368],
          [-54.936560444972336, -18.81206780911066],
          [-54.94548687361015, -18.79256762669204],
          [-54.93759042023449, -18.772740124818515],
          [-54.92248416080019, -18.747834025070617],
          [-54.90634792846152, -18.731902974370026],
          [-54.88986837272577, -18.70881654249837],
          [-54.89261496750711, -18.686702641300826],
          [-54.9049746371117, -18.66848902610102],
          [-54.890898350674874, -18.642140869397224],
          [-54.87270217437926, -18.623922468688782],
          [-54.88746511176651, -18.61611398666183],
          [-54.90463131801982, -18.60635287989115],
          [-54.89536156889653, -18.584551050222764],
          [-54.878195365983814, -18.55656252365408],
          [-54.877165395764905, -18.53247569953938],
          [-54.86068583915756, -18.52889493446345],
          [-54.84077303752443, -18.567628300482568],
          [-54.861372483235044, -18.574462690027783],
          [-54.87441879638362, -18.60732901360783],
          [-54.86823896112446, -18.621970381154107],
          [-54.87304549814563, -18.62782657583628],
          [-54.88643513554147, -18.661983687624108],
          [-54.84729618499342, -18.67987276101285],
          [-54.80335070110485, -18.65352636942064],
          [-54.782064607527964, -18.640839610528527],
          [-54.76970493919785, -18.64376740655926],
          [-54.75356870820966, -18.624247803499035],
          [-54.7703915941966, -18.582923925263874],
          [-54.76318179266138, -18.54126451865137],
          [-54.745765940638286, -18.507734334559327],
          [-54.7203599631662, -18.45889222199682],
          [-54.72104661462802, -18.43218598982194],
          [-54.71692672834002, -18.409058948665393],
          [-54.72173326830922, -18.387231990666212],
          [-54.75194578801372, -18.39016413417941],
          [-54.794861300086, -18.3842998079994],
          [-54.81546074581937, -18.381693376790793],
          [-54.82850706309382, -18.36312140181084],
          [-54.8267904501025, -18.287183614337955],
          [-54.81168419790532, -18.213495428187716],
          [-54.815804089430216, -18.187729805472202],
          [-54.76876178400237, -18.166336907935996],
          [-54.728249548036665, -18.126534602386037],
          [-54.716233211206784, -18.080522303852298],
          [-54.72687626072173, -18.052125717522475],
          [-54.71932313443605, -18.026336335303483],
          [-54.71610880956274, -18.009655529068784],
          [-54.714392192471976, -17.983533377889014],
          [-54.76314421323901, -17.945649397961336],
          [-54.81120958304565, -17.9276843317414],
          [-54.84794526073657, -17.88750131075671],
          [-54.852889935210484, -17.866589471556924],
          [-54.82027415089067, -17.861361124285587],
          [-54.83572373703963, -17.820836246355327],
          [-54.82405072251116, -17.789455814960842],
          [-54.803107954288656, -17.803839195442833],
          [-54.766715607041824, -17.78912890099666],
          [-54.782851839577646, -17.76657076981851],
          [-54.79342321334134, -17.71102965745251],
          [-54.82260576398543, -17.63644644453103],
          [-54.86277468021332, -17.58768897252829],
          [-54.90054032574451, -17.55917244974523],
          [-54.917706529995726, -17.521525918646745],
          [-54.933499438806, -17.471100071972973],
          [-54.9048131673832, -17.445919145582256],
          [-54.88455705598022, -17.378435239174735],
          [-54.86910748164327, -17.307021289211235],
          [-54.86155435637084, -17.27456822766615],
          [-54.86910748767048, -17.23817466483581],
          [-54.854684317142755, -17.18359643280022],
          [-54.85914753329615, -17.13701472037799],
          [-54.84713119654471, -17.103875546211473],
          [-54.84953446604422, -17.086927772159605],
          [-54.835458186814435, -17.040650105173135],
          [-54.853997690487475, -16.948388838264894],
          [-54.8633880362828, -16.869304846715313],
          [-54.847938459413356, -16.8479478589278],
          [-54.86098477559635, -16.789121551369057],
          [-54.881927542268826, -16.73412962950315],
          [-54.8771210100005, -16.696315653027764],
          [-54.911796734575816, -16.63777144012154],
          [-54.90973679378466, -16.59993841866249],
          [-54.94744512574833, -16.582264222121122],
          [-54.97285678481768, -16.55676362536757],
          [-54.96049633542723, -16.52558023768951],
          [-54.950536575251476, -16.520495606925255],
          [-54.92873480052481, -16.489644050494896],
          [-54.937834291940995, -16.45615866840796],
          [-54.993457804046876, -16.47264254079117],
          [-55.11499221753988, -16.444535884147182],
          [-55.17644074228882, -16.41300039916828],
          [-55.2052889477414, -16.369949468980092],
          [-55.225205549765526, -16.38552837369925],
          [-55.31309179267839, -16.382412225825394],
          [-55.33231016129754, -16.391982599369943],
          [-56.84791892248454, -16.4083512160425],
          [-56.92497046915317, -16.35232411258346],
          [-57.04590434464644, -16.249466995912037],
          [-57.19837182047113, -16.031727818398],
          [-57.27338726993407, -16.01681922485901],
          [-57.33468647976915, -16.08042021199957],
          [-57.28094695710632, -15.950307744848153],
          [-57.36247170889684, -16.010289675624293],
          [-57.352069391892385, -15.896414551925439],
          [-57.40444003032838, -15.864955915472265],
          [-57.4504766400601, -15.772051684369053]]])));
Map.addLayer(bap_encosta);

var palette = require('users/mapbiomas/modules:Palettes.js').get('classification7');

// Defina seu asset de entrada
var assetInput = 'projects/ee-barbaracsilva/assets/Collection_8/rocky-outcrop_step2/general-class-post/';
var file_name = 'CERRADO_col8_native14_rocky4';

// Carregue a sua coleção aqui
var collection = ee.Image(assetInput + file_name);
Map.addLayer (collection, {}, "input data");

// Defina seu asset de saída
var assetOutput = 'projects/mapbiomas-workspace/COLECAO8/classificacao';

// Defina a versão de saída
var outputVersion = '15';

// Defina o id de lançamento da coleção mapbiomas
var collectionId = 8.0;

// Se for bioma use este.
var theme = { 'type': 'biome', 'name': 'CERRADO' };

// Se for tema transversal use este.
// var theme = { 'type': 'theme', 'name': 'INFRAURBANA'};

// Defina a fonte produto do dado
var source = 'ipam';

// Todos os anos mapeados na coleção 8
var years = [
    '1985', '1986', '1987', '1988',
    '1989', '1990', '1991', '1992',
    '1993', '1994', '1995', '1996',
    '1997', '1998', '1999', '2000',
    '2001', '2002', '2003', '2004',
    '2005', '2006', '2007', '2008',
    '2009', '2010', '2011', '2012',
    '2013', '2014', '2015', '2016',
    '2017', '2018', '2019', '2020',
    '2021', '2022'
];

// Carregar dado do Pantanal
var pantanal_class = ee.Image('projects/mapbiomas-workspace/COLECAO8/classificacao-pantanal/PANT_col8_Anual_p20f_v38');

// Boundary box de todo o Brasil
var geometry = ee.Geometry.Polygon(
    [
        [
            [-75.46319738935682, 6.627809464162168],
            [-75.46319738935682, -34.62753178950752],
            [-32.92413488935683, -34.62753178950752],
            [-32.92413488935683, 6.627809464162168]
        ]
    ], null, false
);

years.forEach(
    function (year) {

        var imageYear = collection.select('classification_' + year);

        imageYear = imageYear.rename('classification');

        imageYear = imageYear
            .set('territory', 'BRAZIL')
            .set('biome', 'CERRADO')
            .set('collection_id', collectionId)
            .set('version', outputVersion)
            .set('source', source)
            .set('year', parseInt(year, 10))
            .set('description', 'native3_rocky4_versionB');

        var vis = {
            'min': 0,
            'max': 62,
            'palette': palette,
            'format': 'png'
        };

       var name = year + '-' + outputVersion;

        if (theme.type === 'biome') {
            name = theme.name + '-' + name;
        }
        
        print(imageYear);
        
        // perform reclassification of mosaic of agriculture and pasture to pasture into protected areas (except APAs and TIs)
        // build mask
        // import protected areas
        var pa = ee.Image(1).clip(
                    ee.FeatureCollection('projects/mapbiomas-workspace/AUXILIAR/areas-protegidas')
                            .filterMetadata('categoria', 'not_equals', 'APA')
                            .filterMetadata('categoria', 'not_equals', ''));

        // remap 21 into UCs to 15
        imageYear = imageYear.where(imageYear.eq(21).and(pa.eq(1)), 15);
       
        // remap 12 into mask to 29
        // imageYear = imageYear.where(imageYear.eq(12).and(geometry_mask.eq(1)), 29);
        
        // remap 11 into mask to 12
        // imageYear = imageYear.where(imageYear.eq(11).and(wetland_to_grassland.eq(1)), 12);
        // imageYear = imageYear.where(imageYear.eq(11).and(wetland_to_grassland2.eq(1)), 12);


        Map.addLayer(imageYear, vis, theme.name + ' ' + year, false);
        //print ('output', imageYear)
        
        // Aplicar correção na BAP
        var pantanal_i = pantanal_class.select('classification_' + year);
        //print(pantanal_i, 'pantanal i')
        
        imageYear = imageYear.where(bap_encosta.eq(1).and(imageYear.eq(21).and(pantanal_i.eq(3))), 3)
        
        Map.addLayer(imageYear, vis, theme.name + ' ' + year + ' com ajuste BAP', false);
        
        Export.image.toAsset({
            'image': imageYear,
            'description': name,
            'assetId': assetOutput + '/' + name,
            'pyramidingPolicy': {'.default': 'mode'},
            'region': geometry,
            'scale': 30,
            'maxPixels': 1e13
        });
    }
);

var cerrado =  ee.FeatureCollection('projects/mapbiomas-workspace/AUXILIAR/biomas-2019').filter(ee.Filter.eq('Bioma','Cerrado'));
var line = ee.Image().paint(cerrado,'empty',3).visualize({palette:'FF0000'});
Map.addLayer(line, {min:0, max:1}, 'Cerrado limit');
